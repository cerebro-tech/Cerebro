#!/usr/bin/env bash
set -euo pipefail

DISK="/dev/sda"
#DISK="/dev/nvme0n1"
USERNAME="j"
PASSWORD="'''" 

echo "==> 0. Enabling NTP"
timedatectl set-ntp true

echo "==> 1. Secure erase + setting the block size to 4KB"
#nvme format -f --ses=1 --lbaf=1 $DISK
wipefs -a $DISK
sgdisk --zap-all $DISK

sgdisk -n1:0:+1981M -t1:EF00 -c1:"BOOT" "$DISK"
sgdisk -n2:0:+64G -t2:8304 -c2:"ROOT" "$DISK"
sgdisk -n3:0:0 -t3:8300 -c3:"DATA" "$DISK"
sgdisk -p "$DISK"

echo "==> 2. Formatting partitions"
mkfs.fat -n BOOT -F32 "${DISK}1"
#mkfs.fat -F 32 -s 8 -S 512 -n BOOT ${DISK}p1
mkfs.f2fs -l ROOT -f -O extra_attr,inode_checksum,sb_checksum,compression "${DISK}2"
#mkfs.f2fs -l ROOT -f -O extra_attr,inode_checksum,sb_checksum,compression -C lz4 ${DISK}p2
mkfs.xfs -L DATA -f "${DISK}3"
#mkfs.xfs -L DATA -f ${DISK}p3

echo "==>3. Mounting partitions"
mount -t f2fs -o noatime,nodiratime,compress_algorithm=lz4,compress_chksum "${DISK}2" /mnt
#mount -t f2fs -o defaults,noatime,nodiscard,compress_algorithm=lz4,compress_chksum,fastboot ${DISK}p2 /mnt
mkdir -p /mnt/{boot,data}
mount -t vfat -o noatime,nodiratime "${DISK}1" /mnt/boot
mount -t xfs -o noatime,nodiratime,inode64,logbsize=64k "${DISK}3" /mnt/data

echo "==>4. Generating fstab"
genfstab -L /mnt >> /mnt/etc/fstab

echo "==>5. Installing base system + packages"
pacstrap /mnt \
  base base-devel linux linux-headers \
  xfsprogs dosfstools efibootmgr sudo nano zsh \
  intel-ucode nvidia-dkms nvidia-utils \
  networkmanager ly \
  gnome-shell gnome-control-center gnome-tweaks gnome-console gnome-system-monitor gnome-text-editor nautilus \
  pipewire pipewire-alsa pipewire-jack pipewire-pulse wireplumber \
  xdg-desktop-portal-gnome \
  xorg xorg-xinit xorg-xwayland \
  ccache mold ninja --noconfirm --needed

echo "==>6. Chroot and configure the system ==="
arch-chroot /mnt /bin/bash <<CHROOT_EOF
set -euo pipefail

curl -s https://raw.githubusercontent.com/cerebro-tech/Cerebro/main/makepkg.conf > /etc/makepkg.conf
curl -s https://raw.githubusercontent.com/cerebro-tech/Cerebro/main/pacman.conf > /etc/pacman.conf

echo "cerebro" > /etc/hostname
useradd -m -G wheel,audio,video,storage,network,power -s /bin/zsh "$USERNAME"
echo "$USERNAME:$PASSWORD" | chpasswd

mkdir -p "/home/$USERNAME"
chown "$USERNAME:$USERNAME" "/home/$USERNAME"
chmod 700 "/home/$USERNAME"

mkdir -p /etc/sudoers.d
echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/10-wheel
chmod 440 /etc/sudoers.d/10-wheel
visudo -c || true

echo "==>7. Initramfs Customization"
sed -i 's/^HOOKS=.*/HOOKS=(base udev autodetect microcode modconf block filesystems keyboard)/' /etc/mkinitcpio.conf
sed -i 's/^#COMPRESSION=.*/COMPRESSION="lz4"/' /etc/mkinitcpio.conf
sed -i 's/^#COMPRESSION_OPTIONS=.*/COMPRESSION_OPTIONS=(-4)/' /etc/mkinitcpio.conf

echo "==>8. Generate Initramfs for all kernels"
mkinitcpio -P

echo "==>9. Systemd tuning"
sed -i 's/^#DefaultTimeoutStartSec=.*/DefaultTimeoutStartSec=7s/' /etc/systemd/system.conf
sed -i 's/^#DefaultTimeoutStopSec=.*/DefaultTimeoutStopSec=7s/' /etc/systemd/system.conf
systemctl disable systemd-networkd-wait-online.service 2>/dev/null || true

echo "==>10. Boot entry creating"
efibootmgr -c -d $DISK -p 1 -L "Cerebro Arch" \
    -l /vmlinuz-linux \
    -u "root=LABEL=ROOT rw rootfstype=f2fs rootflags=compress_algorithm=lz4,compress_chksum quiet loglevel=3 initrd=\initramfs-linux.img"

systemctl enable NetworkManager ly.service || true

echo "==>11. Chroot configuration done"
CHROOT_EOF

echo "==> 12. Finalize & cleanup"
umount -R /mnt || true

echo "Installation finished."
echo "- Consider adding kernel cmdline options (via firmware/efibootmgr):"
echo "- quiet loglevel=3 rd.systemd.show_status=auto rd.udev.log_level=3 vt.global_cursor_default=0"
echo "Reboot when ready."
