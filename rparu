#!/usr/bin/env bash
# ~/cerebro_scripts/rparu
# RAM-aware wrapper for paru

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"
RAM_BUILD="$SCRIPT_DIR/ram_build.sh"

if [[ $# -eq 0 ]]; then
    echo "Usage: rparu <paru-args>"
    exit 1
fi

# Build in RAM
if [[ "$1" == "-Syu" ]]; then
    # Update all AUR packages
    paru -Syu --noconfirm
else
    # Build package in RAM using ram_build.sh
    PACKAGE_DIR="$HOME/.cache/aur/$(echo "$1" | tr '/' '_')"
    mkdir -p "$PACKAGE_DIR"
    cd "$PACKAGE_DIR"

    # Download package snapshot
    paru -G "$1" --noconfirm --cachedir "$PACKAGE_DIR"
    PKG_SRC_DIR=$(find . -maxdepth 1 -type d -name "$1*" | head -n1)
    if [[ -z "$PKG_SRC_DIR" ]]; then
        echo "[!] Failed to find source directory for $1"
        exit 1
    fi

    cd "$PKG_SRC_DIR"
    "$RAM_BUILD" .
fi
